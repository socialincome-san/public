name: Website

on:
  pull_request:
    paths-ignore:
      - "recipients_app/**"
  push:
    branches:
      - main
    paths-ignore:
      - "recipients_app/**"

jobs:
  check_applicability:
    name: Check applicability
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          paths: '["website/**", ".github/workflows/website.yml"]'
          skip_after_successful_duplicate: "false"
          do_not_skip: '["push"]'

  test:
    name: Test website
    needs: check_applicability
    if: needs.check_applicability.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Initialize repository
        uses: ./.github/workflows/actions/init

      - name: Run linters
        run: npm run website:lint

      - name: Run typecheck
        run: npm run website:build-paths && npm run typecheck

      - name: Run unit tests
        run: npm run website:test

      - name: Test build
        env:
          STORYBLOK_PREVIEW_SECRET: ${{ secrets.STORYBLOK_PREVIEW_SECRET }}
          STORYBLOK_PREVIEW_TOKEN: ${{ secrets.STORYBLOK_PREVIEW_TOKEN }}
        run: |
          mv website/.env.development website/.env.production
          npm run website:build:emulator

      - name: Set up Terraform CLI
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.6

      - name: Terraform Init (no backend)
        run: terraform -chdir=website/infra init -backend=false

      - name: Terraform Format Check
        run: terraform -chdir=website/infra fmt -check

      - name: Terraform Validate
        run: terraform -chdir=website/infra validate
