name: Build and Deploy to Google Cloud Run via Terraform

on:
  push:
    branches:
      - feat/gcp-poc  # Change to main later when stable

env:
  ENVIRONMENT: staging
  APP_NAME: portal
  GCP_PROJECT_ID: social-income-poc
  GCP_REGION: europe-west6
  DOMAIN_NAME: portal.staging-socialincome.org
  ARTIFACT_REGISTRY_NAME: staging_portal_google_artifact_registry_repository
  TERRAFORM_DIR: portal/infra
  TF_LOG: DEBUG

jobs:
  deploy:
    name: Build & Deploy Cloud Run Service
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS_TERRAFORM_DEPLOYER }}

      - name: âš™ï¸ Configure Docker to use Artifact Registry
        run: |
          echo "ğŸ›  Configuring Docker authentication for Artifact Registry"
          gcloud auth configure-docker $GCP_REGION-docker.pkg.dev --quiet

      - name: ğŸ§° Set up Terraform CLI
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.6

      - name: ğŸ” Build Image & Deploy to Cloud Run via Terraform
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          TF_VAR_env: ${{ env.ENVIRONMENT }}
          TF_VAR_app_name: ${{ env.APP_NAME }}
          TF_VAR_gcp_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_gcp_region: ${{ env.GCP_REGION }}
          TF_VAR_domain_name: ${{ env.DOMAIN_NAME }}
        run: |
          echo "ğŸ§  Generating image tag from Git SHA..."
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_URL="$GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY_NAME/$APP_NAME:$SHORT_SHA"

          echo "TF_VAR_docker_image_url=$IMAGE_URL" >> $GITHUB_ENV

          echo "ğŸ§­ Initializing Terraform..."
          terraform init -backend-config="_staging.tfbackend"     
               
          echo "ğŸ§ª Running terraform fmt check..."
          terraform fmt -check

          echo "ğŸ§ª Validating Terraform..."
          terraform validate

          echo "ğŸš€ Applying Terraform..."
          terraform apply -auto-approve

          echo "ğŸŒ Cloud Run URL:"
          terraform output cloud_run_url

          echo "âœ… Deployment complete!"
