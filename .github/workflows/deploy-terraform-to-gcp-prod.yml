name: Website / Deploy with Terraform to GCP / Prod

on:
  push:
    tags:
      - release-*

env:
  ENVIRONMENT: prod
  APP_NAME: website
  GCP_PROJECT_ID: social-income-prod
  GCP_REGION: europe-west1
  ARTIFACT_REGISTRY_NAME: prod-website-google-artifact-registry-repository
  TERRAFORM_DIR: website/infra
  WEBSITE_DOMAIN: socialincome.org

jobs:
  deploy:
    name: Deploy Prod
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.TF_PROD_TERRAFORM_DEPLOYER_CREDENTIALS }}

      - name: âš™ï¸ Configure Docker to use Artifact Registry
        run: |
          echo "ðŸ›  Configuring Docker authentication for Artifact Registry"
          gcloud auth configure-docker $GCP_REGION-docker.pkg.dev --quiet

      - name: ðŸ§° Set up Terraform CLI
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.6

      - name: ðŸ“ Prepare Docker build secrets
        run: |
          mkdir -p secrets
          echo "${GITHUB_REF_NAME}" > secrets/NEXT_PUBLIC_APP_VERSION
          echo "${{ env.ENVIRONMENT }}" > secrets/NEXT_PUBLIC_APP_ENVIRONMENT
          echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > secrets/APP_BUILD_TIMESTAMP
          echo "${{ secrets.TF_PROD_BASE_URL }}" > secrets/BASE_URL
          echo "${{ secrets.TF_PROD_EXCHANGE_RATES_API }}" > secrets/EXCHANGE_RATES_API
          echo "${{ secrets.TF_PROD_SCHEDULER_API_KEY }}" > secrets/SCHEDULER_API_KEY
          echo "${{ secrets.TF_PROD_FIREBASE_DATABASE_URL }}" > secrets/FIREBASE_DATABASE_URL
          echo "${{ secrets.TF_PROD_FIREBASE_SERVICE_ACCOUNT_JSON }}" > secrets/FIREBASE_SERVICE_ACCOUNT_JSON
          echo "${{ secrets.TF_PROD_GITHUB_PAT }}" > secrets/GITHUB_PAT
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FACEBOOK_TRACKING_ID}}" > secrets/NEXT_PUBLIC_FACEBOOK_TRACKING_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_API_KEY }}" > secrets/NEXT_PUBLIC_FIREBASE_API_KEY
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_APP_ID }}" > secrets/NEXT_PUBLIC_FIREBASE_APP_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" > secrets/NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}" > secrets/NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" > secrets/NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" > secrets/NEXT_PUBLIC_FIREBASE_PROJECT_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" > secrets/NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID}}" > secrets/NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID
          echo "${{ secrets.TF_PROD_NEXT_PUBLIC_LINKEDIN_TRACKING_ID}}" > secrets/NEXT_PUBLIC_LINKEDIN_TRACKING_ID
          echo "${{ secrets.TF_PROD_SENTRY_AUTH_TOKEN }}" > secrets/SENTRY_AUTH_TOKEN
          echo "${{ secrets.TF_PROD_STORYBLOK_PREVIEW_SECRET }}" > secrets/STORYBLOK_PREVIEW_SECRET
          echo "${{ secrets.TF_PROD_STORYBLOK_PREVIEW_TOKEN }}" > secrets/STORYBLOK_PREVIEW_TOKEN

      - name: ðŸ“¤ Build and Push Docker Image
        env:
          IMAGE_URL: "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.APP_NAME }}:${{ github.sha }}"
        run: |
          echo "ðŸ“¤ Building Docker image: $IMAGE_URL"
          docker buildx build \
            --platform linux/amd64 \
            --tag "$IMAGE_URL" \
            --push \
            -f website/Dockerfile \
            $(for f in secrets/*; do echo "--secret id=$(basename "$f"),src=$f"; done) \
            .

          echo "ðŸš€ Image built and pushed."

      - name: ðŸŒ± Terraform Init, Validate & Apply
        env:
          TF_LOG: INFO
          TF_VAR_env: ${{ env.ENVIRONMENT }}
          TF_VAR_app_name: ${{ env.APP_NAME }}
          TF_VAR_gcp_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_gcp_region: ${{ env.GCP_REGION }}
          TF_VAR_website_domain: ${{ env.WEBSITE_DOMAIN }}
          TF_VAR_postfinance_ftp_host: ${{ vars.POSTFINANCE_FTP_HOST }}
          TF_VAR_postfinance_ftp_port: ${{ vars.POSTFINANCE_FTP_PORT }}
          TF_VAR_postfinance_ftp_user: ${{ vars.POSTFINANCE_FTP_USER }}
          TF_VAR_postfinance_payments_files_bucket: ${{ vars.POSTFINANCE_PAYMENTS_FILES_BUCKET }}
          TF_VAR_postfinance_ftp_rsa_private_key_base64: ${{ secrets.POSTFINANCE_FTP_RSA_PRIVATE_KEY_BASE64 }}
          TF_VAR_scheduler_api_key: ${{ secrets.TF_PROD_SCHEDULER_API_KEY }}
          TF_VAR_stripe_product_onetime: ${{ secrets.TF_PROD_STRIPE_PRODUCT_ONETIME }}
          TF_VAR_stripe_product_recurring: ${{ secrets.TF_PROD_STRIPE_PRODUCT_RECURRING }}
          TF_VAR_stripe_secret_key: ${{ secrets.TF_PROD_STRIPE_SECRET_KEY }}
          TF_VAR_stripe_webhook_secret: ${{ secrets.TF_PROD_STRIPE_WEBHOOK_SECRET }}
          TF_VAR_sendgrid_api_key: ${{ secrets.TF_PROD_SENDGRID_API_KEY }}
          TF_VAR_sendgrid_list_id: ${{ secrets.TF_PROD_SENDGRID_LIST_ID }}
          TF_VAR_sendgrid_suppression_list_id: ${{ secrets.TF_PROD_SENDGRID_SUPPRESSION_LIST_ID }}
          TF_VAR_twilio_account_sid: ${{ secrets.TF_PROD_TWILIO_ACCOUNT_SID }}
          TF_VAR_twilio_auth_token: ${{ secrets.TF_PROD_TWILIO_AUTH_TOKEN }}
          TF_VAR_twilio_verify_service_sid: ${{ secrets.TF_PROD_TWILIO_VERIFY_SERVICE_SID }}
          IMAGE_URL: "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.APP_NAME }}:${{ github.sha }}"
        run: |
          echo "ðŸ§­ Initializing Terraform..."
          terraform -chdir=${{ env.TERRAFORM_DIR }} init -backend-config="_prod.tfbackend"

          echo "ðŸ§ª Checking formatting..."
          terraform -chdir=${{ env.TERRAFORM_DIR }} fmt -check

          echo "ðŸ§ª Validating configuration..."
          terraform -chdir=${{ env.TERRAFORM_DIR }} validate

          echo "ðŸš€ Applying Terraform changes..."
          terraform -chdir=${{ env.TERRAFORM_DIR }} apply -auto-approve -input=false \
            -var="docker_image_url=$IMAGE_URL"

          echo "âœ… Terraform applied successfully."
