name: execute-draw
on:
  push:
    branches: [main]
permissions:
  contents: write
  pull-requests: write
env:
  BOT_NAME: "drawbot"
  BOT_EMAIL: "drawbot@noemail.com"

jobs:
  execute_draw:
    if: "!contains(github.event.head_commit.author, 'drawbot')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Install nodejs ğŸ”§
        uses: actions/setup-node@v3
        with:
          node-version: latest

      - name: Install dchoose ğŸ”§
        run: npm install -g dchoose

      - name: Make folders if necessary ğŸ“
        run: |
          mkdir -p ./recipients_selection/draws
          mkdir -p ./recipients_selection/lists

      - name: Draw ğŸ²
        working-directory: recipients_selection
        run: ./draw.sh

      - name: Configure some git params ğŸ”§
        run: |
          git config --global user.name $BOT_NAME
          git config --global user.email $BOT_EMAIL

      - name: Commit and raise PR ğŸ”
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: .
          title: "Completed recipient draw"
          commit-message: "completed a recipient draw"
          body: "completed a recipient draw"
          token: ${{ secrets.PAT_TOKEN }}
          branch: draw/results
          branch-suffix: timestamp
